<!doctype html>
<html lang="en">
    <title>Hello, world!</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <style>
      #results .input-group {
        position: relative;
      }
      #results .input-group .graph {
        display: flex;
        justify-content: end;
        align-items: center;
        padding-right: 3% ;
        border-radius: 0.25rem;
        position: absolute;
        z-index: 999;
        top: 0;
        left: 0;
        height: 100%;
        color: white;
        background-color: #343a40;
      }
      #results .input-group input {
        border: none;
        border-top-right-radius: 0.25rem;
        border-bottom-right-radius: 0.25rem;
      }
    </style>
  </head>
  <body class="bg-dark">
    <div class="container">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <div class="card card-body text-center mt-5">
            <h1 class="heading display-5 pb-3">Enter your CLV</h1>
            <form id="loan-form">
              <div class="form-group">
               
              <div class="form-group">
                <input type="text" class="form-control" id="clv" placeholder="CLV">
              </div>
              <div class="forn-group">
                <input type="submit" value="Calculate" class="btn btn-dark btn-block">
              </div>
            </form>
            <!-- LOADER -->
            
            <div id="loading" style="display: none;">
              <img src="img/loading.gif" alt="">
            </div>
            
            <!-- RESULTS -->
            <div id="results" style="display: none;" class="pt-4">
              <h5 class="text-left">Results</h5>
              <div class="form-group">
                <h6>CAC</h6>
                <div class="input-group">
                  <input type="text" class="form-control text-center" id="cac" disabled>
                </div>
              </div>
              <div class="form-group">
                <h6>Ratio</h6>
                <div class="input-group">
                  <input type="text" class="form-control text-center" id="r" disabled>
                  <span class="graph"></span>
                </div>
              </div>
              <div class="form-group">
                <h6>Warm Lead Value</h6>
                <div class="input-group">
                  <input type="text" class="form-control text-center" id="lv" disabled>
                  <span class="graph"></span>
                </div>
              </div>
              <div class="form-group">
                <h6>Close Ratio</h6>
                <div class="input-group">
                  <input type="text" class="form-control text-center" id="cr" disabled>
                  <span class="graph"></span>
                </div>
              </div>
              <div class="form-group">
                <h6>CPL</h6>
                <div class="input-group">
                  <input type="text" class="form-control text-center" id="cpl" disabled>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.5.3/dist/cleave.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <!-- Optional JavaScript -->
    <script>
      const CLV = document.getElementById('clv');
      let cleave = new Cleave('#clv', {
        numeral: true,
        numeralThousandsGroupStyle: 'thousand',
        prefix: '$',
        rawValueTrimPrefix: true,
      });
      document.getElementById('loan-form').addEventListener('submit',calculate);
      function calculate (e) {
        
        // UI Variables
        const CAC_Value = document.getElementById('cac');
        const r_Value = document.getElementById('r');
        const lv_Value = document.getElementById('lv');
        const cr_Value = document.getElementById('cr');
        const CPL_Results = document.getElementById('cpl');
        let closeRatio = 0.25;
        let leadValue = 0.15;
        let ratio = 3;
        if (window.location.search === ""){
          // use default values
        }else{
          //new values
          closeRatio = Number(window.location.search.split("cr=")[1].split("&")[0])/100;
          leadValue = Number(window.location.search.split("lv=")[1].split("&")[0])/100;
          ratio = Number(window.location.search.split("r=")[1].split("&")[0]);
        }
        r_Value.nextElementSibling.textContent = `${((1/ratio) * 100).toFixed(0)}%`;
        r_Value.nextElementSibling.style.width = `${((1/ratio) * 100).toFixed(0)}%`;
        lv_Value.nextElementSibling.textContent = `${leadValue * 100}%`;
        lv_Value.nextElementSibling.style.width = `${leadValue * 100}%`;
        cr_Value.nextElementSibling.textContent = `${closeRatio * 100}%`;
        cr_Value.nextElementSibling.style.width = `${closeRatio * 100}%`;
        if(cleave.getRawValue()) {
          let CAC = cleave.getRawValue()/ratio;
          CAC_Value.value = `$${CAC.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
          let CPD = CAC * closeRatio;
          let CPL = CPD * leadValue;
          if(CPL < 200){
            CPL_Results.value = "Your CPL is to low";
          }else {
            
            CPL_Results.value = `$${CPL.toLocaleString(undefined, { maximumFractionDigits: 2 })} `;
          }
          
          document.getElementById('results').style.display = 'none';
          document.getElementById('loading').style.display = 'block';
          setTimeout(showResults,1000);
        } else {
          showError('Please check your numbers');
        }
        
        e.preventDefault();
      }
      function showError(error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger' ;
        errorDiv.textContent = error;
        const card = document.querySelector('.card');
        const heading = document.querySelector('.heading');
        card.insertBefore(errorDiv, heading);
        setTimeout(clearError , 3000);
      }
      function clearError () {
        document.querySelector('.alert').remove();
      }
      function showResults () {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
      }
    </script>
  </body>
</html>